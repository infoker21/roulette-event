<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
  <script defer src="./js/Winwheel.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:100,300,400,500,700,900&display=swap&subset=korean"
    rel="stylesheet">
  <link rel="stylesheet" href="./css/reset.css">
  <link rel="stylesheet" href="./css/style.css">
  <title>Roulette Event</title>
</head>

<body>
  <div id="wrap">
    <div class="roulette">
      <h1 class="roulette__tit"><img src="./image/wroulette_title.png" alt=""></h1>
      <div class="roulette__container">
        <div class="roulette__needle">
          <img src="./image/needle.png" alt="">
        </div>
        <img src="./image/wroulette.png" alt="" class="roulette__bg">
        <canvas id="canvas" width="300" height="300"></canvas>
        <nav class="roulette__btn">
          <button type="button">START!</button>
        </nav>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', e => {
      let wheel_spinning = false;
      let roulette = new Winwheel({ //휠 객체 생성
        'numSegments': 8,
        'outerRadius': 135, // 캔버스 영억 반지름
        'textFontSize': 18,
        'responsive': true,
        'drawMode': 'code',
        'segments': [{
            'fillStyle': '#e51116',
            'text': '100만원',
          },
          {
            'fillStyle': '#ffffff',
            'text': '100만원',
          },
          {
            'fillStyle': '#e51116',
            'text': '100만원',
          },
          {
            'fillStyle': '#ffffff',
            'text': '100만원',
          },
          {
            'fillStyle': '#e51116',
            'text': '100만원',
          },
          {
            'fillStyle': '#ffffff',
            'text': '100만원',
          },
          {
            'fillStyle': '#e51116',
            'text': '100만원',
          },
          {
            'fillStyle': '#000',
            'text': '꽝',
            'textFillStyle': '#fff',
          }

        ],
        'animation': {
          'type': 'spinToStop',
          'duration': 1,
          'spins': 4,
          'easing': 'Power0.easeOut',
          'stopAngle': null,
          'direction': 'clockwise',
          'repeat': -1,
          'yoyo': false,
          callbackFinished: alertPrize
        }
      });

      let btn = document.querySelector('.roulette__btn button');
      btn.addEventListener('click', e => { // 버튼 클릭 이벤트
        const TARGET = e.currentTarget;

        if(!TARGET.classList.contains('start')){ // Roulette 시작
          roulette.startAnimation();
          TARGET.innerText = 'STOP!';
          TARGET.classList.add('start');
        } else { // Roulette 멈춤

          if(wheel_spinning === true){
            return false;
          }
          wheel_spinning = true;

          roulette.animation.repeat = 0;
          roulette.animation.easing = "Power3.easeOut";
          roulette.animation.duration = 3;
          roulette.animation.spins = 8;
          
          calculatePrize();
          roulette.startAnimation();
          
          TARGET.innerText = 'WAIT..';
        }
      })

      
      function calculatePrize() { // 회전하기 전에 stopAngle을 미리 정하는 함수 (조작)
        
        const RANDOM_NUMBER = Math.floor(Math.random() * 10000) + 1; // 1부터 100 사이의 랜덤한 수를 출력
        let stop_angle = 0;
        let segment_angle = 360 / parseInt(roulette.numSegments);

        console.log(RANDOM_NUMBER);

        if (RANDOM_NUMBER === 1) {
          stop_angle = Math.floor((Math.random() * (segment_angle - 10)));
        } else if (RANDOM_NUMBER === 2) {
          stop_angle = ((segment_angle) + 5) + Math.floor((Math.random() * (segment_angle - 10)));
        } else if (RANDOM_NUMBER === 3) {
          stop_angle = ((segment_angle * 2) + 5) + Math.floor((Math.random() * (segment_angle - 10)));
        } else if (RANDOM_NUMBER === 4) {
          stop_angle = ((segment_angle * 3) + 5) + Math.floor((Math.random() * (segment_angle - 10)));
        } else if (RANDOM_NUMBER === 5) {
          stop_angle = ((segment_angle * 4) + 5) + Math.floor((Math.random() * (segment_angle - 10)));
        } else if (RANDOM_NUMBER === 6) {
          stop_angle = ((segment_angle * 5) + 5) + Math.floor((Math.random() * (segment_angle - 10)));
        } else if (RANDOM_NUMBER === 7) {
          stop_angle = ((segment_angle * 6) + 5) + Math.floor((Math.random() * (segment_angle - 10)));
        } else {
          stop_angle = ((segment_angle * 7) + 5) + Math.floor((Math.random() * (segment_angle - 10)));
        }

        roulette.animation.stopAngle = stop_angle; // 애니메이션이 회전 되기 전에 stopAngle 값을 지정
        roulette.startAnimation();
      }
      
      function resetWheel() { // Roulette reset
        
        roulette.stopAnimation(false); // 콜백 기능이 작동하지 않도록 매개 변수처럼 false인 애니메이션을 중지

        roulette.rotationAngle = 0;
        roulette.draw();
        roulette.animation.repeat = -1;
        roulette.animation.easing = "Power0.easeOut";
        roulette.animation.duration = 1;
        roulette.animation.spins = 4;

        btn.innerText = 'START!';
        btn.classList.remove('start');

        wheel_spinning = false; // wheel_spinning initial
      }

      // -----------------------------------------------
      // 애니메이션 종료 후 호출되는 함수
      // -----------------------------------------------
      function alertPrize(indicatedSegment) {
        if (indicatedSegment.text === '꽝') {
          alert(`${indicatedSegment.text} 다음기회에!`);
        } else {
          alert(`축하합니다 ${indicatedSegment.text} 당첨되었습니다!`);
        }

        resetWheel();
      }
    })
  </script>
</body>

</html>